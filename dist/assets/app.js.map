{
  "version": 3,
  "sources": ["../../src/main.ts"],
  "sourcesContent": ["const startButton = document.getElementById(\"start\") as HTMLButtonElement | null;\r\nconst statusEl = document.getElementById(\"status\");\r\nconst noteEl = document.getElementById(\"note\");\r\nconst centsEl = document.getElementById(\"cents\");\r\n\r\nconst NOTE_NAMES = [\"C\", \"C#\", \"D\", \"D#\", \"E\", \"F\", \"F#\", \"G\", \"G#\", \"A\", \"A#\", \"B\"] as const;\r\nconst A4 = 440;\r\n\r\ntype PitchSample = { midi: number; cents: number; hz: number; conf: number; rms: number };\r\n\r\nconst history: PitchSample[] = [];\r\nconst HISTORY_N = 5;\r\n\r\nlet lockedMidi: number | null = null;\r\nlet candidateMidi: number | null = null;\r\nlet candidateCount = 0;\r\n\r\nlet centsEma: number | null = null;\r\n\r\nfunction freqToMidi(freqHz: number): number {\r\n  return Math.round(12 * Math.log2(freqHz / A4) + 69);\r\n}\r\n\r\nfunction midiToFreq(midi: number): number {\r\n  return A4 * Math.pow(2, (midi - 69) / 12);\r\n}\r\n\r\nfunction centsOffFromMidi(freqHz: number, midi: number): number {\r\n  return 1200 * Math.log2(freqHz / midiToFreq(midi));\r\n}\r\n\r\nfunction midiToNoteName(midi: number): string {\r\n  const name = NOTE_NAMES[((midi % 12) + 12) % 12];\r\n  const octave = Math.floor(midi / 12) - 1; // MIDI octave convention\r\n  return `${name}${octave}`;\r\n}\r\n\r\nlet lastMidi: number | null = null;\r\nlet lastFreq: number | null = null;\r\n\r\nfunction smoothFreq(newFreq: number): number {\r\n  // simple 1-pole low-pass on frequency\r\n  if (lastFreq == null) return (lastFreq = newFreq);\r\n  const alpha = 0.25; // higher = more responsive, lower = smoother\r\n  lastFreq = lastFreq + alpha * (newFreq - lastFreq);\r\n  return lastFreq;\r\n}\r\n\r\nfunction median(values: number[]): number {\r\n  const a = [...values].sort((x, y) => x - y);\r\n  const mid = Math.floor(a.length / 2);\r\n  return a.length % 2 ? a[mid] : (a[mid - 1] + a[mid]) / 2;\r\n}\r\n\r\nfunction wrapCents(c: number): number {\r\n  // Keep cents in [-50, +50) relative to the chosen nearest note\r\n  // (your cents calc already does this, but this is a safety clamp)\r\n  if (c >= 50) return c - 100;\r\n  if (c < -50) return c + 100;\r\n  return c;\r\n}\r\n\r\nfunction setStatus(msg: string) {\r\n  if (statusEl) statusEl.textContent = msg;\r\n}\r\n\r\nfunction setReading(note: string | null, cents: string | null) {\r\n  if (noteEl) noteEl.textContent = note ?? \"\";\r\n  if (centsEl) centsEl.textContent = cents ?? \"\";\r\n}\r\n\r\nsetStatus(\"Idle\");\r\nsetReading(null, null);\r\n\r\nlet audioContext: AudioContext | null = null;\r\nlet micStream: MediaStream | null = null;\r\nlet workletNode: AudioWorkletNode | null = null;\r\n\r\nasync function startAudio() {\r\n  setStatus(\"Requesting microphone permission\u2026\");\r\n\r\n  micStream = await navigator.mediaDevices.getUserMedia({\r\n    audio: {\r\n      echoCancellation: false,\r\n      noiseSuppression: false,\r\n      autoGainControl: false,\r\n    },\r\n  });\r\n\r\n  setStatus(\"Creating AudioContext\u2026\");\r\n  audioContext = new AudioContext({ latencyHint: \"interactive\" });\r\n  await audioContext.resume();\r\n\r\n  setStatus(\"Loading worklet module\u2026\");\r\n  await audioContext.audioWorklet.addModule(\"/assets/worklet.js\");\r\n\r\n  setStatus(\"Creating audio graph\u2026\");\r\n  const source = audioContext.createMediaStreamSource(micStream);\r\n\r\n  workletNode = new AudioWorkletNode(audioContext, \"tuner\");\r\n\r\nworkletNode.port.onmessage = (ev) => {\r\n  const data = ev.data as any;\r\n\r\n  if (data?.type === \"worklet-ready\") {\r\n    setStatus(`Worklet ready. sr=${data.sampleRate}, ring=${data.bufferSize}`);\r\n    return;\r\n  }\r\n\r\n  if (data?.type === \"pitch\") {\r\n    const freqHz: number | null = data.freqHz ?? null;\r\n    const confidence: number = Number(data.confidence ?? 0);\r\n    const rms: number = Number(data.rms ?? 0);\r\n\r\n    if (freqHz == null) {\r\n        // Reset state when no pitch\r\n        history.length = 0;\r\n        lockedMidi = null;\r\n        candidateMidi = null;\r\n        candidateCount = 0;\r\n        centsEma = null;\r\n\r\n        setReading(null, null);\r\n        setStatus(`No pitch (rms=${rms.toFixed(4)}, conf=${confidence.toFixed(2)})`);\r\n        return;\r\n    }\r\n\r\n    // Convert to midi/note first\r\n    const midi = freqToMidi(freqHz);\r\n    const centsRaw = wrapCents(centsOffFromMidi(freqHz, midi));\r\n\r\n    history.push({ midi, cents: centsRaw, hz: freqHz, conf: confidence, rms });\r\n    if (history.length > HISTORY_N) history.shift();\r\n\r\n    // Median filter to kill spikes\r\n    const medMidi = Math.round(median(history.map(h => h.midi)));\r\n    const medCents = median(history.map(h => h.cents));\r\n\r\n    // Note lock: require the new note to persist for a few frames\r\n    if (lockedMidi == null) {\r\n        lockedMidi = medMidi;\r\n    } else if (medMidi !== lockedMidi) {\r\n        if (candidateMidi !== medMidi) {\r\n            candidateMidi = medMidi;\r\n            candidateCount = 1;\r\n        } else {\r\n            candidateCount++;\r\n        }\r\n\r\n        // Require persistence. At ~20 Hz, 3 frames \u2248 150 ms.\r\n        const framesToSwitch = 3;\r\n        if (candidateCount >= framesToSwitch) {\r\n            lockedMidi = candidateMidi;\r\n            candidateMidi = null;\r\n            candidateCount = 0;\r\n            centsEma = null; // reset smoothing when note changes\r\n        }   \r\n    } else {\r\n        // same note, clear candidate\r\n        candidateMidi = null;\r\n        candidateCount = 0;\r\n    }\r\n\r\n    // Smooth cents with EMA (on the locked note)\r\n    if( lockedMidi == null ) return; // should not happen\r\n    const centsForLocked = wrapCents(centsOffFromMidi(freqHz, lockedMidi));\r\n    const alpha = 0.2; // responsiveness vs smoothness\r\n    centsEma = centsEma == null ? centsForLocked : (centsEma + alpha * (centsForLocked - centsEma));\r\n\r\n    const note = midiToNoteName(lockedMidi);\r\n    setReading(note, `${centsEma >= 0 ? \"+\" : \"\"}${centsEma.toFixed(1)} cents`);\r\n    setStatus(`Hz=${freqHz.toFixed(2)} rms=${rms.toFixed(4)} conf=${confidence.toFixed(2)}`);\r\n    \r\n  }\r\n\r\n  setStatus(`Worklet message: ${JSON.stringify(data)}`);\r\n};\r\n\r\n\r\n  source.connect(workletNode);\r\n}\r\n\r\nstartButton?.addEventListener(\"click\", async () => {\r\n  startButton.disabled = true;\r\n  setReading(null, null);\r\n\r\n  try {\r\n    await startAudio();\r\n  } catch (err) {\r\n    console.error(err);\r\n    setStatus(\r\n      err instanceof Error ? `Error: ${err.message}` : \"Error starting audio\"\r\n    );\r\n    startButton.disabled = false;\r\n  }\r\n});\r\n"],
  "mappings": "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",
  "names": []
}
